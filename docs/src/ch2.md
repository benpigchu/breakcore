# 第二章：用户态和用户程序、批处理系统

## 准备用户程序

用户程序和内核一样，都是 RV64 架构上的 no_std 程序，只是运行在用户态而已，所以我们用类似的方法就可以建立起用户程序的 Crate。但是这里略有区别的是，user 是一个库，而其中附带了一些用户程序放在 bin 文件夹里。由于这样的文件布局，我们需要在 bin 文件内使用 `extern crate` 来引用用户库。

除此之外我们还需要想办法方便内核跳转到用户程序，而这就需要我们使用链接器脚本来调整入口的位置。同时，我们还需要自行提供初始化用的 `_start` 函数。和内核中不同的是，我们的栈已经由内核准备好了，所以我们可以用 Rust 而不是汇编来编写这个函数。注意 `#[link_section = ".text.entry"]` 这个标记为我们特别设定了此函数所在的段，这样我们才能在链接器脚本中固定这个函数的位置。当然，我们还需要  `#[no_mangle]` 和 `extern "C"` 来方便内核调用它。

最后我们需要在 `_start` 中调用主函数。但是，如果我们没有在库里放一个主函数，那么就无法通过编译。于是为了使库中的主函数能够被用户程序覆盖，我们需要加入 `#[linkage = "weak"]` 来使函数重复时能被覆盖。

## 进入用户态，以及回到内核态